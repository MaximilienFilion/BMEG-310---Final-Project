---
title: "Final Project Part 1"
author:
- "Maximilien Filion - 20598645, "
- "Aneesh Kaura - 66832304, "
- "Monica Mihailescu - 47409289 "
date: "2025-11-17"
output:
  pdf_document: default
  html_document: default
---

# Final Project Part 1
## Clinical data Analysis

### Download the data
```{r}
RNAseq_KIRC <- read.csv("RNAseq_KIRC.csv")
data_clinical_patient <- read.delim("data_clinical_patient.txt", header = TRUE, sep = "\t", skip = 4)
data_mutations <- read.delim("data_mutations.txt", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
head(data_clinical_patient)
```

### Run the intersect of all the patient sets - code reused from lab 7 submission
```{r}
# RNAseq_KIRC dataset
rna_patient_ids <- gsub("\\.", "-", substr(colnames(RNAseq_KIRC), 1, 12))

# Data_clinical_patient dataset
clinical_patient_ids <- unique(data_clinical_patient$PATIENT_ID)

# Data_mutation dataset
mutation_patient_ids <- unique(substr(data_mutations$Tumor_Sample_Barcode, 1, 12))

# Common patients
common_patients <- Reduce(intersect, list(rna_patient_ids, clinical_patient_ids, mutation_patient_ids))
```

### Data Cleaning
```{r}
# Tumour Stage: AJCC_PATHOLOGIC_TUMOR_STAGE
# OS: Overall Survival - Time from the start of the study/treatment to death from any cause.
# DSS: Disease-Specific Survival - Time from the start of the study/treatment to death specifically due to the cancer.
# DFS: Disease-Free Survival - Time from the date of cure until the first sign of disease recurrence or death from any cause.
# PFS: Progression-Free Survival - Time from the start of treatment until the first sign of disease growth/spread (progression) or death from any cause.

#colnames(data_clinical_patient)
# Step 1: Inspect unique values to see exact formatting
unique(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Step 2: Clean the column (remove spaces, lowercase, handle NAs)
stages <- trimws(tolower(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE))

# Convert Roman numerals to numbers 
data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE <- sapply(stages, function(x) {
  if (grepl("stage", x)) {
    as.numeric(as.roman(gsub("stage ", "", x)))
  } else {
    NA  
  }
})

library(dplyr)
library(stringr)

# Convert OS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    OS_clean = toupper(str_replace_all(OS_STATUS, " ", "")),
    OS_STATUS = str_replace_all(OS_clean, c(
       "0:LIVING" = "1", 
       "1:DECEASED" = "0")
       ),
    # Convert the resulting column to numeric
    OS_STATUS = as.numeric(OS_STATUS)
  )

# Convert DSS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    DSS_clean = toupper(str_replace_all(DSS_STATUS, " ", "")),
    DSS_STATUS = str_replace_all(DSS_clean, c(
       "0:ALIVEORDEADTUMORFREE" = "1", 
       "1:DEADWITHTUMOR" = "0")
       ),
    # Convert the resulting column to numeric
    DSS_STATUS = as.numeric(DSS_STATUS)
  )

# Convert DFS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    DFS_clean = toupper(str_replace_all(DFS_STATUS, " ", "")),
    DFS_STATUS = str_replace_all(DFS_clean, c(
       "0:DISEASEFREE" = "1", 
       "1:RECURRED/PROGRESSED" = "0")
       ),
    # Convert the resulting column to numeric
    DFS_STATUS = as.numeric(DFS_STATUS)
  )

# Convert PFS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    PFS_clean = toupper(str_replace_all(PFS_STATUS, " ", "")),
    PFS_STATUS = str_replace_all(PFS_clean, c(
       "0:CENSORED" = "1", 
       "1:PROGRESSION" = "0")
       ),
    # Convert the resulting column to numeric
    PFS_STATUS = as.numeric(PFS_STATUS)
)
head(data_clinical_patient, 100)
```

## Data Exploration 
### Age of KIRC Patients
```{r}
# Age associated with patients
# Check this - I got rid of matching step 
#common_patient_ages <- data_clinical_patient$AGE[match(common_patients, data_clinical_patient$PATIENT_ID)]

# Load the ggplot2 library
library(ggplot2)

# Convert to a dataframe
age_df <- data.frame(AGE = data_clinical_patient$AGE)

# Plot the boxplot
ggplot(age_df, aes(x = AGE)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(
    title = "Distribution of Ages Among Patients",
    x = "Age (years)",
    y = ""
    ) +
  theme_minimal(base_size = 14)
```

What did we notice?

### Tumor Stage of KIRC Patients
```{r}
# Tumor stage associated with patients
# Convert to a dataframe
stage_df <- data.frame(STAGE = data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Plot the bar graph
ggplot(stage_df, aes(x = STAGE)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(
    title = "Number of Patients by Tumor Stage",
    x = "Tumor Stage",
    y = "Count"
  ) +
  theme_minimal(base_size = 14)
```

What did we notice?

### Sex, Ethnicity, Race, and Ancestry of KIRC Patients
```{r}
# Find the different Categories
#head(data_clinical_patient, 30)
#unique(data_clinical_patient$GENETIC_ANCESTRY_LABEL)

library(ggplot2)

plot_donut <- function(data, column_name, title) {
  # Convert to character
  col <- as.character(data[[column_name]])
  # Replace blank or whitespace-only values with "Unknown" to label its column 
  col[trimws(col) == ""] <- "Unknown"
  
  # If this is the ancestry column, apply the cleaner label mapping
  if (column_name == "GENETIC_ANCESTRY_LABEL") {
    ancestry_labels <- c(
      "AFR"        = "African",
      "AFR_ADMIX"  = "African (Admixed)",
      "AMR"        = "Americas / Latino",
      "EAS"        = "East Asian",
      "EAS_ADMIX"  = "East Asian (Admixed)",
      "EUR"        = "European",
      "EUR_ADMIX"  = "European (Admixed)",
      "SAS_ADMIX"  = "South Asian (Admixed)",
      "Unknown"    = "Unknown"
    )
    # Map values - unmapped values become NA, so protect against that
    col <- ifelse(col %in% names(ancestry_labels),
                  ancestry_labels[col],
                  col)
  }

  # Build frequency table
  freq <- table(col)
  df <- as.data.frame(freq)
  colnames(df) <- c("Category", "Count")
  df$Fraction <- df$Count / sum(df$Count)
  
  # Build legend labels with percentages
  legend_labels <- paste0(df$Category, " (", round(df$Fraction * 100, 1), "%)")
  names(legend_labels) <- df$Category
  
  ggplot(df, aes(x = "", y = Fraction, fill = Category)) +
    geom_col(width = 1) +
    coord_polar("y") +
    scale_fill_discrete(labels = legend_labels) +
    labs(title = title, fill = column_name) +
    theme_void()
}

plot_donut(data_clinical_patient, "SEX", "Sex Distribution")
plot_donut(data_clinical_patient, "ETHNICITY", "Ethnicity Distribution")
plot_donut(data_clinical_patient, "RACE", "Race Distribution")
plot_donut(data_clinical_patient, "GENETIC_ANCESTRY_LABEL", "Ancestry Distribution")
```

What did we notice?

### Survival Analysis of Overall Survival (OS)
```{r}

library(survival)
library(survminer)
# Create a survival object
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS) 
# Note: OS_STATUS: 1 = alive, 0 = deceased, so event = 1 - OS_STATUS

# Fit Kaplan-Meier model
fit_os <- survfit(surv_os ~ 1)

# Plot
ggsurvplot(fit_os,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Overall Survival (OS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Disease-Specific Survival (DSS)
```{r}
surv_dss <- Surv(time = data_clinical_patient$DSS_MONTHS, 
                 event = 1 - data_clinical_patient$DSS_STATUS)

fit_dss <- survfit(surv_dss ~ 1)

ggsurvplot(fit_dss,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Disease-Specific Survival (DSS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Progression-Free Survival(PFS)
```{r}
surv_pfs <- Surv(time = data_clinical_patient$PFS_MONTHS, 
                 event = 1 - data_clinical_patient$PFS_STATUS)

fit_pfs <- survfit(surv_pfs ~ 1)

ggsurvplot(fit_pfs,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Progression-Free Survival (PFS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Disease-Free Survival (DFS)
```{r}
surv_dfs <- Surv(time = data_clinical_patient$DFS_MONTHS, 
                 event = 1 - data_clinical_patient$DFS_STATUS)

fit_dfs <- survfit(surv_dfs ~ 1)

ggsurvplot(fit_dfs,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Disease-Free Survival (DFS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Age
```{r}
# Create age groups (above vs below median)
median_age <- median(data_clinical_patient$AGE, na.rm = TRUE)
data_clinical_patient$AGE_GROUP <- ifelse(data_clinical_patient$AGE <= median_age, 
                                          paste0("<= ", median_age), 
                                          paste0("> ", median_age))

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by age group
fit_age <- survfit(surv_os ~ AGE_GROUP, data = data_clinical_patient)


# Plot
ggsurvplot(fit_age,
           data = data_clinical_patient,
           pval = TRUE,   # shows log-rank p-value
           conf.int = TRUE,
           palette = c("skyblue", "blue"),
           title = "Overall Survival by Age Group",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Cancer Stage
```{r}
# Make sure stage is factor
data_clinical_patient$STAGE_FACTOR <- factor(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by tumor stage
fit_stage <- survfit(surv_os ~ STAGE_FACTOR, data = data_clinical_patient) # All my values show N/A for AJCC_PATHOLOGIC, therefore nothing will work here. 

# Plot
ggsurvplot(fit_stage,
           data = data_clinical_patient,
           pval = TRUE,
           conf.int = TRUE,
           palette = "Set1",
           title = "Overall Survival by Tumor Stage",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))

```

What did we notice?

### Survival Analysis of Sex
```{r}
# Make sure sex is factor
data_clinical_patient$SEX <- factor(ifelse(is.na(data_clinical_patient$SEX) | 
                                           data_clinical_patient$SEX == "", 
                                           "Unknown", 
                                           data_clinical_patient$SEX))

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by sex
fit_sex <- survfit(surv_os ~ SEX, data = data_clinical_patient)

# Plot
ggsurvplot(fit_sex,
           data = data_clinical_patient,
           pval = TRUE,
           conf.int = TRUE,
           palette = c("skyblue", "salmon", "grey"),
           title = "Overall Survival by Sex",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```


## Mutation Data Analysis
  1) Build a gene-patient matrix that contains mutation data. Within this matrix, "1" represents whether there is a mutation in a given gene and given patient and "0" represents no mutation. Note, when building this matrix, you can take into account the type of mutations (e.g., synonymous, non-synonymous, etc)  
```{r}

```

  2) Pick the top 20 or most frequently mutated genes from this matrix.    
```{r}

```

  3) Perform clustering on the resulting mutation matrix Perhaps try ward and ward.D2 linkage methods if you see narrow clusters.
```{r}

```
  
  4) Take the clusters of patients and (a) see if outcome data between patient clusters is different, (b) see if any other clinical data is different when you compare patient clusters - how much overlap do you see between the patient clusters?
```{r}

```

