---
title: "Final Project Part 1"
author:
- "Maximilien Filion - 20598645, "
- "Aneesh Kaura - 66832304, "
- "Monica Mihailescu - 47409289 "
date: "2025-11-17"
output:
  pdf_document: default
  html_document: default
---

# Final Project Part 1
## Clinical data Analysis

### Download the data
```{r}
RNAseq_KIRC <- read.csv("RNAseq_KIRC.csv")
data_clinical_patient <- read.delim("data_clinical_patient.txt", header = TRUE, sep = "\t", skip = 4)
data_mutations <- read.delim("data_mutations.txt", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
head(data_clinical_patient)
```

### Run the intersect of all the patient sets - code reused from lab 7 submission
```{r}
# RNAseq_KIRC dataset
rna_patient_ids <- gsub("\\.", "-", substr(colnames(RNAseq_KIRC), 1, 12))

# Data_clinical_patient dataset
clinical_patient_ids <- unique(data_clinical_patient$PATIENT_ID)

# Data_mutation dataset
mutation_patient_ids <- unique(substr(data_mutations$Tumor_Sample_Barcode, 1, 12))

# Common patients
common_patients <- Reduce(intersect, list(rna_patient_ids, clinical_patient_ids, mutation_patient_ids))
```

### Data Cleaning
```{r}
# Tumour Stage: AJCC_PATHOLOGIC_TUMOR_STAGE
# OS: Overall Survival - Time from the start of the study/treatment to death from any cause.
# DSS: Disease-Specific Survival - Time from the start of the study/treatment to death specifically due to the cancer.
# DFS: Disease-Free Survival - Time from the date of cure until the first sign of disease recurrence or death from any cause.
# PFS: Progression-Free Survival - Time from the start of treatment until the first sign of disease growth/spread (progression) or death from any cause.

#colnames(data_clinical_patient)
# Step 1: Inspect unique values to see exact formatting
unique(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Step 2: Clean the column (remove spaces, lowercase, handle NAs)
stages <- trimws(tolower(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE))

# Convert Roman numerals to numbers 
data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE <- sapply(stages, function(x) {
  if (grepl("stage", x)) {
    as.numeric(as.roman(gsub("stage ", "", x)))
  } else {
    NA  
  }
})

library(dplyr)
library(stringr)

# Convert OS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    OS_clean = toupper(str_replace_all(OS_STATUS, " ", "")),
    OS_STATUS = str_replace_all(OS_clean, c(
       "0:LIVING" = "1", 
       "1:DECEASED" = "0")
       ),
    # Convert the resulting column to numeric
    OS_STATUS = as.numeric(OS_STATUS)
  )

# Convert DSS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    DSS_clean = toupper(str_replace_all(DSS_STATUS, " ", "")),
    DSS_STATUS = str_replace_all(DSS_clean, c(
       "0:ALIVEORDEADTUMORFREE" = "1", 
       "1:DEADWITHTUMOR" = "0")
       ),
    # Convert the resulting column to numeric
    DSS_STATUS = as.numeric(DSS_STATUS)
  )

# Convert DFS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    DFS_clean = toupper(str_replace_all(DFS_STATUS, " ", "")),
    DFS_STATUS = str_replace_all(DFS_clean, c(
       "0:DISEASEFREE" = "1", 
       "1:RECURRED/PROGRESSED" = "0")
       ),
    # Convert the resulting column to numeric
    DFS_STATUS = as.numeric(DFS_STATUS)
  )

# Convert PFS into binary Value, where 1 is survival and 0 is end-point
data_clinical_patient <- data_clinical_patient %>%
  mutate(
    #convert to uppercase and remove spaces
    PFS_clean = toupper(str_replace_all(PFS_STATUS, " ", "")),
    PFS_STATUS = str_replace_all(PFS_clean, c(
       "0:CENSORED" = "1", 
       "1:PROGRESSION" = "0")
       ),
    # Convert the resulting column to numeric
    PFS_STATUS = as.numeric(PFS_STATUS)
)
head(data_clinical_patient, 100)
```

## Data Exploration 
### Age of KIRC Patients
```{r}
# Age associated with patients
# Check this - I got rid of matching step 
#common_patient_ages <- data_clinical_patient$AGE[match(common_patients, data_clinical_patient$PATIENT_ID)]

# Load the ggplot2 library
library(ggplot2)

# Convert to a dataframe
age_df <- data.frame(AGE = data_clinical_patient$AGE)

# Plot the boxplot
ggplot(age_df, aes(x = AGE)) +
  geom_boxplot(fill = "skyblue", color = "black") +
  labs(
    title = "Distribution of Ages Among Patients",
    x = "Age (years)",
    y = ""
    ) +
  theme_minimal(base_size = 14)
```

What did we notice?

### Tumor Stage of KIRC Patients
```{r}
# Tumor stage associated with patients
# Convert to a dataframe
stage_df <- data.frame(STAGE = data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Plot the bar graph
ggplot(stage_df, aes(x = STAGE)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(
    title = "Number of Patients by Tumor Stage",
    x = "Tumor Stage",
    y = "Count"
  ) +
  theme_minimal(base_size = 14)
```

What did we notice?

### Sex, Ethnicity, Race, and Ancestry of KIRC Patients
```{r}
# Find the different Categories
#head(data_clinical_patient, 30)
#unique(data_clinical_patient$GENETIC_ANCESTRY_LABEL)

library(ggplot2)

plot_donut <- function(data, column_name, title) {
  # Convert to character
  col <- as.character(data[[column_name]])
  # Replace blank or whitespace-only values with "Unknown" to label its column 
  col[trimws(col) == ""] <- "Unknown"
  
  # If this is the ancestry column, apply the cleaner label mapping
  if (column_name == "GENETIC_ANCESTRY_LABEL") {
    ancestry_labels <- c(
      "AFR"        = "African",
      "AFR_ADMIX"  = "African (Admixed)",
      "AMR"        = "Americas / Latino",
      "EAS"        = "East Asian",
      "EAS_ADMIX"  = "East Asian (Admixed)",
      "EUR"        = "European",
      "EUR_ADMIX"  = "European (Admixed)",
      "SAS_ADMIX"  = "South Asian (Admixed)",
      "Unknown"    = "Unknown"
    )
    # Map values - unmapped values become NA, so protect against that
    col <- ifelse(col %in% names(ancestry_labels),
                  ancestry_labels[col],
                  col)
  }

  # Build frequency table
  freq <- table(col)
  df <- as.data.frame(freq)
  colnames(df) <- c("Category", "Count")
  df$Fraction <- df$Count / sum(df$Count)
  
  # Build legend labels with percentages
  legend_labels <- paste0(df$Category, " (", round(df$Fraction * 100, 1), "%)")
  names(legend_labels) <- df$Category
  
  ggplot(df, aes(x = "", y = Fraction, fill = Category)) +
    geom_col(width = 1) +
    coord_polar("y") +
    scale_fill_discrete(labels = legend_labels) +
    labs(title = title, fill = column_name) +
    theme_void()
}

plot_donut(data_clinical_patient, "SEX", "Sex Distribution")
plot_donut(data_clinical_patient, "ETHNICITY", "Ethnicity Distribution")
plot_donut(data_clinical_patient, "RACE", "Race Distribution")
plot_donut(data_clinical_patient, "GENETIC_ANCESTRY_LABEL", "Ancestry Distribution")
```

What did we notice?

### Survival Analysis of Overall Survival (OS)
```{r}

library(survival)
library(survminer)
# Create a survival object
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS) 
# Note: OS_STATUS: 1 = alive, 0 = deceased, so event = 1 - OS_STATUS

# Fit Kaplan-Meier model
fit_os <- survfit(surv_os ~ 1)

# Plot
ggsurvplot(fit_os,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Overall Survival (OS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Disease-Specific Survival (DSS)
```{r}
surv_dss <- Surv(time = data_clinical_patient$DSS_MONTHS, 
                 event = 1 - data_clinical_patient$DSS_STATUS)

fit_dss <- survfit(surv_dss ~ 1)

ggsurvplot(fit_dss,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Disease-Specific Survival (DSS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Progression-Free Survival(PFS)
```{r}
surv_pfs <- Surv(time = data_clinical_patient$PFS_MONTHS, 
                 event = 1 - data_clinical_patient$PFS_STATUS)

fit_pfs <- survfit(surv_pfs ~ 1)

ggsurvplot(fit_pfs,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Progression-Free Survival (PFS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Disease-Free Survival (DFS)
```{r}
surv_dfs <- Surv(time = data_clinical_patient$DFS_MONTHS, 
                 event = 1 - data_clinical_patient$DFS_STATUS)

fit_dfs <- survfit(surv_dfs ~ 1)

ggsurvplot(fit_dfs,
           data = data_clinical_patient,
           risk.table = TRUE,
           conf.int = TRUE,
           palette = "Dark2",
           title = "Kaplan-Meier Curve: Disease-Free Survival (DFS)",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Age
```{r}
# Create age groups (above vs below median)
median_age <- median(data_clinical_patient$AGE, na.rm = TRUE)
data_clinical_patient$AGE_GROUP <- ifelse(data_clinical_patient$AGE <= median_age, 
                                          paste0("<= ", median_age), 
                                          paste0("> ", median_age))

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by age group
fit_age <- survfit(surv_os ~ AGE_GROUP, data = data_clinical_patient)


# Plot
ggsurvplot(fit_age,
           data = data_clinical_patient,
           pval = TRUE,   # shows log-rank p-value
           conf.int = TRUE,
           palette = c("skyblue", "blue"),
           title = "Overall Survival by Age Group",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

What did we notice?

### Survival Analysis of Cancer Stage
```{r}
# Make sure stage is factor
data_clinical_patient$STAGE_FACTOR <- factor(data_clinical_patient$AJCC_PATHOLOGIC_TUMOR_STAGE)

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by tumor stage
fit_stage <- survfit(surv_os ~ STAGE_FACTOR, data = data_clinical_patient) # All my values show N/A for AJCC_PATHOLOGIC, therefore nothing will work here. 

# Plot
ggsurvplot(fit_stage,
           data = data_clinical_patient,
           pval = TRUE,
           conf.int = TRUE,
           palette = "Set1",
           title = "Overall Survival by Tumor Stage",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))

```

What did we notice?

### Survival Analysis of Sex
```{r}
# Make sure sex is factor
data_clinical_patient$SEX <- factor(ifelse(is.na(data_clinical_patient$SEX) | 
                                           data_clinical_patient$SEX == "", 
                                           "Unknown", 
                                           data_clinical_patient$SEX))

# Survival object for OS
surv_os <- Surv(time = data_clinical_patient$OS_MONTHS, 
                event = 1 - data_clinical_patient$OS_STATUS)

# Fit Kaplan-Meier by sex
fit_sex <- survfit(surv_os ~ SEX, data = data_clinical_patient)

# Plot
ggsurvplot(fit_sex,
           data = data_clinical_patient,
           pval = TRUE,
           conf.int = TRUE,
           palette = c("skyblue", "salmon", "grey"),
           title = "Overall Survival by Sex",
           xlab = "Time (Months)",
           ylab = "Survival Probability",
           ggtheme = theme_minimal(base_size = 14))
```

## Analyses

==============================================================================
# SECTION 3: MUTATION DATA ANALYSIS
# ==============================================================================

# ==============================================================================
# INVESTIGATION 1: Top 20 Most Mutated Genes
# ==============================================================================

## 3.1 Build Gene-Patient Mutation Matrix (Data Frame)
# Create binary matrix: rows = genes, columns = patients
We decided to keep only the damaging mutations and exclude the potentially damageable or non-damageable mutations.
```{r inv1_matrix}
# Damaging and Potentially Pathogenic Mutations
damaging_classes <- c(
  "Nonsense_Mutation", "Frame_Shift_Del", "Frame_Shift_Ins",
  "Splice_Site", "Nonstop_Mutation", "Translation_Start_Site",
  "In_Frame_Del", "In_Frame_Ins", "Missense_Mutation"
)

# Filter Synonymous/Silent mutations and ensure that only common patients are kept
damaging_mutations <- data_mutations[
  data_mutations$Variant_Classification %in% damaging_classes, ]

non_synonymous_dataset <- damaging_mutations[
  substr(damaging_mutations$Tumor_Sample_Barcode, 1, 12) %in% common_patients, ]

# Make a gene list
genes <- unique(non_synonymous_dataset$Hugo_Symbol)

# Create gene-patient matrix
gene_patient_matrix <- matrix(
  0, 
  nrow = length(genes), 
  ncol = length(common_patients),
  dimnames = list(genes, common_patients)
)

# Populate the Matrix
for (i in 1:nrow(non_synonymous_dataset)) {
  
  gene_name <- non_synonymous_dataset$Hugo_Symbol[i]
  patient_id <- substr(non_synonymous_dataset$Tumor_Sample_Barcode[i], 1, 12)
  
  gene_patient_matrix[gene_name, patient_id] <- 1
}

# Convert to Data frame
gene_patient_matrix <- as.data.frame(gene_patient_matrix)
```

## 3.2 Calculate Mutation Frequencies
# Sum mutations across all patients for each gene
```{r inv1_frequency}
# Create a relative frequency vector
gene_frequency_vector <- data.frame(
  Hugo_Symbol = rownames(gene_patient_matrix),
  Frequency = (rowSums(gene_patient_matrix))/(ncol(gene_patient_matrix))
)

# Sort genes by mutation frequency (descending)
gene_frequency_vector <- gene_frequency_vector[order(-gene_frequency_vector$Frequency), , drop = FALSE]

# Extract top 20 genes
top_20_genes <- head(gene_frequency_vector, 20)

# Display top 20 genes
top_20_genes
```

## 3.3 Visualize Top 20 Mutated Genes
# Create bar plot or lollipop chart
```{r inv1_visualize}
# Create visualization of top 20 genes. Create a relative frequency so the data makes more sense
ggplot(top_20_genes, aes(x = reorder(Hugo_Symbol, -Frequency), y = Frequency)) +
  geom_col(fill = "steelblue") +
  labs(title = "Top 20 Non-Synonymously Mutated Genes in KIRC",
       x = "Gene",
       y = "Relative Mutation Frequency") +
  theme_minimal() +
  theme(
  plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
  axis.text.x = element_text(angle = 45, hjust = 1),
  axis.text.y = element_text(size = 12)
  )
```

**Observations:**
# [COMMENT HERE: Which genes are most frequently mutated? Any expected oncogenes?]


# ==============================================================================
# INVESTIGATION 2: Hierarchical Clustering of Mutated Genes
# ==============================================================================

## 3.4 Prepare Data for Hierarchical Clustering
# Use gene-patient matrix with top genes or all genes
```{r inv2_prep}
# Decide on genes to include (top N or all with sufficient mutations)
# [INSERT CODE HERE]

# Prepare matrix for clustering (may need to transpose)
# [INSERT CODE HERE]

# Handle missing values if any
# [INSERT CODE HERE]
```

## 3.5 Apply Ward Hierarchical Clustering
# Perform hierarchical clustering with Ward linkage
```{r inv2_ward}
# Calculate distance matrix
# Suggested distance: Euclidean or Binary (Jaccard/Hamming)
# [INSERT CODE HERE]

# Apply Ward linkage clustering
# [INSERT CODE HERE]

# Generate dendrogram
# [INSERT CODE HERE]

# Determine optimal number of clusters
# Methods: dendrogram inspection, silhouette analysis, elbow method
# [INSERT CODE HERE]

# Cut dendrogram to create cluster assignments
# [INSERT CODE HERE]

# Display cluster sizes
# [INSERT CODE HERE]
```

## 3.6 Apply Ward.D2 Hierarchical Clustering
# Repeat with Ward.D2 linkage method
```{r inv2_ward_d2}
# Apply Ward.D2 linkage clustering
# [INSERT CODE HERE]

# Generate dendrogram
# [INSERT CODE HERE]

# Cut dendrogram for cluster assignments
# [INSERT CODE HERE]

# Compare cluster sizes with Ward method
# [INSERT CODE HERE]
```

## 3.7 Compare Clustering Methods
# Evaluate agreement between Ward and Ward.D2
```{r inv2_compare}
# Create comparison table or confusion matrix
# [INSERT CODE HERE]

# Calculate agreement metrics (e.g., Adjusted Rand Index)
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Do both methods identify similar clusters? Which seems better?]


# ==============================================================================
# INVESTIGATION 3: Patient Outcomes Across Hierarchical Clusters
# ==============================================================================

## 3.8 Assign Patients to Clusters
# Link cluster assignments to patient clinical data
```{r inv3_assign}
# Add cluster assignment to clinical data
# Use clusters from best hierarchical method (Ward or Ward.D2)
# [INSERT CODE HERE]

# Display cluster distribution
# [INSERT CODE HERE]
```

## 3.9 Kaplan-Meier Curves by Cluster
# Compare survival outcomes across clusters
```{r inv3_survival}
# --- Overall Survival (OS) ---
# [INSERT CODE HERE]

# --- Disease-Specific Survival (DSS) ---
# [INSERT CODE HERE]

# --- Progression-Free Survival (PFS) ---
# [INSERT CODE HERE]

# --- Disease-Free Survival (DFS) ---
# [INSERT CODE HERE]

# Perform log-rank tests for each outcome
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Do clusters show different survival patterns?]

## 3.10 ANOVA for Continuous Variables
# Test if age differs significantly across clusters
```{r inv3_anova}
# One-way ANOVA for age
# [INSERT CODE HERE]

# If significant, perform Tukey HSD post-hoc test
# [INSERT CODE HERE]

# Visualize age distribution by cluster (boxplot)
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Do clusters have different age distributions?]

## 3.11 Chi-Square Tests for Categorical Variables
# Test if categorical variables differ across clusters
```{r inv3_chisq}
# --- Tumor Stage ---
# [INSERT CODE HERE]

# --- Sex ---
# [INSERT CODE HERE]

# --- Ethnicity ---
# [INSERT CODE HERE]

# Create contingency tables and visualizations
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Which clinical variables differ by cluster?]


# ==============================================================================
# INVESTIGATION 4: Density-Based Clustering (HDBSCAN)
# ==============================================================================

## 3.12 Prepare Data for HDBSCAN
# Use same gene-patient matrix as hierarchical clustering
```{r inv4_prep}
library(dbscan)

# Prepare matrix (same as Investigation 2)
# [INSERT CODE HERE]

# Optional: Perform dimensionality reduction for visualization
# Methods: PCA, t-SNE, UMAP
# [INSERT CODE HERE]
```

## 3.13 Apply HDBSCAN Clustering
# Perform density-based clustering
```{r inv4_hdbscan}
# Apply HDBSCAN with parameter tuning
# Key parameters: minPts (min_cluster_size), min_samples
# [INSERT CODE HERE]

# Extract cluster assignments (note: -1 or 0 may indicate noise/outliers)
# [INSERT CODE HERE]

# Display cluster sizes (including noise)
# [INSERT CODE HERE]
```

## 3.14 Visualize HDBSCAN Clusters
# Plot clusters in reduced dimensional space
```{r inv4_visualize}
# If dimensionality reduction was performed, create scatter plot
# Color points by cluster assignment
# [INSERT CODE HERE]

# Highlight noise/outlier points
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: How many clusters detected? Are they well-separated?]


# ==============================================================================
# INVESTIGATION 5: Patient Outcomes Across HDBSCAN Clusters
# ==============================================================================

## 3.15 Assign Patients to HDBSCAN Clusters
# Link HDBSCAN cluster assignments to clinical data
```{r inv5_assign}
# Add HDBSCAN cluster to clinical data
# [INSERT CODE HERE]

# Decide how to handle noise/outlier group
# Options: exclude, analyze separately, group with closest cluster
# [INSERT CODE HERE]

# Display cluster distribution
# [INSERT CODE HERE]
```

## 3.16 Kaplan-Meier Curves by HDBSCAN Cluster
# Compare survival outcomes across density-based clusters
```{r inv5_survival}
# --- Overall Survival (OS) ---
# [INSERT CODE HERE]

# --- Disease-Specific Survival (DSS) ---
# [INSERT CODE HERE]

# --- Progression-Free Survival (PFS) ---
# [INSERT CODE HERE]

# --- Disease-Free Survival (DFS) ---
# [INSERT CODE HERE]

# Perform log-rank tests
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Do HDBSCAN clusters differ in survival?]

## 3.17 ANOVA for Continuous Variables (HDBSCAN)
# Test age differences across HDBSCAN clusters
```{r inv5_anova}
# One-way ANOVA for age
# [INSERT CODE HERE]

# Post-hoc tests if significant
# [INSERT CODE HERE]

# Visualization
# [INSERT CODE HERE]
```

## 3.18 Chi-Square Tests for Categorical Variables (HDBSCAN)
# Test categorical variable differences
```{r inv5_chisq}
# Tumor stage, sex, ethnicity, etc.
# [INSERT CODE HERE]

# Contingency tables and visualizations
# [INSERT CODE HERE]
```

## 3.19 Compare Hierarchical vs HDBSCAN Results
# Evaluate which clustering method better separates patient subgroups
```{r inv5_compare}
# Compare statistical significance of survival differences
# [INSERT CODE HERE]

# Compare clinical variable associations
# [INSERT CODE HERE]

# Discuss which method identifies more meaningful subgroups
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Which clustering approach is more informative?]


# ==============================================================================
# INVESTIGATION 6: Co-Mutation and Mutual Exclusivity Analysis
# ==============================================================================

## 3.20 Create Fisher's Exact Test Function
# Function to test co-occurrence or mutual exclusivity between gene pairs
```{r inv6_function}
# Function: fisher_test_genes(gene1, gene2, mutation_matrix)
# Inputs: Two gene names and mutation matrix
# Outputs: Odds ratio, p-value, relationship type
# [INSERT CODE HERE]
```

## 3.21 Test All Pairwise Combinations of Top 20 Genes
# Run Fisher's exact test for all gene pairs
```{r inv6_pairwise}
# Get top 20 genes from Investigation 1
# [INSERT CODE HERE]

# Generate all pairwise combinations (190 pairs)
# [INSERT CODE HERE]

# Apply Fisher's exact test to each pair
# Store results in dataframe: gene1, gene2, odds_ratio, p_value
# [INSERT CODE HERE]
```

## 3.22 Multiple Testing Correction
# Adjust p-values for multiple comparisons
```{r inv6_correction}
# Apply Bonferroni correction
# [INSERT CODE HERE]

# OR apply Benjamini-Hochberg FDR correction
# [INSERT CODE HERE]

# Filter for significant pairs (adjusted p-value < 0.05)
# [INSERT CODE HERE]
```

## 3.23 Identify Co-Mutation and Mutual Exclusivity
# Classify significant gene pairs
```{r inv6_classify}
# Co-mutation: Odds ratio > 1 and significant p-value
# [INSERT CODE HERE]

# Mutual exclusivity: Odds ratio < 1 and significant p-value
# [INSERT CODE HERE]

# Sort and display top co-mutating pairs
# [INSERT CODE HERE]

# Sort and display top mutually exclusive pairs
# [INSERT CODE HERE]
```

## 3.24 Visualize Gene-Gene Relationships
# Create heatmap and network diagram
```{r inv6_visualize}
# Create heatmap of odds ratios for top 20 genes
# [INSERT CODE HERE]

# Create network diagram showing significant relationships
# Nodes = genes, Edges = significant co-mutation/exclusivity
# Color edges by relationship type
# [INSERT CODE HERE]

# Create co-occurrence matrix
# [INSERT CODE HERE]
```

**Observations:**
# [COMMENT HERE: Which gene pairs co-mutate? Any mutual exclusivity patterns?]


# ==============================================================================
# INVESTIGATION 7: Disease-Specific Survival and Top 20 Genes
# ==============================================================================

## 3.25 Survival Analysis for Each Top Gene
# Test association between each gene mutation and DSS
```{r inv7_individual}

library(survival) # Does the Kaplan-Meier curves and Cox Regression
library(survminer) # Makes survival plots

# Get the top 20 genes
top_20_gene_names <- top_20_genes$Hugo_Symbol

# Initialize results dataframe
# Creates and empty dataframe to store results
gene_dss_results <- data.frame(
  Gene = character(),
  Mutated_Patients = integer(),
  Non_Mutated_Patients = integer(),
  Hazard_Ratio = numeric(),
  CI_Lower = numeric(),
  CI_Upper = numeric(),
  P_Value = numeric(),
  Log_Rank_P = numeric(),
  stringsAsFactors = FALSE
)

# Create a list to store survival plots
survival_plots_list <- list()

# Loop through each of the top 20 genes
for (gene in top_20_gene_names) {
  
  # Get mutation status for this gene across common patients
  gene_mutations <- gene_patient_matrix[gene, ]
  
  # Create a temporary dataframe matching patients
  temp_df <- data.frame(
    PATIENT_ID = names(gene_mutations),
    Gene_Mutated = as.numeric(gene_mutations),
    stringsAsFactors = FALSE
  )
  
  # Merge with clinical data (Joins mutation statue with clincal survival data)
  merged_data <- merge(
    data_clinical_patient,
    temp_df,
    by = "PATIENT_ID",
    all.x = FALSE
  )
  
  # Remove rows with missing DSS data
  merged_data <- merged_data[!is.na(merged_data$DSS_MONTHS) & 
                             !is.na(merged_data$DSS_STATUS), ]
  
  # Count patients in each group
  n_mutated <- sum(merged_data$Gene_Mutated == 1) #How many have the mutation
  n_non_mutated <- sum(merged_data$Gene_Mutated == 0)#How many don't
  
  # Skip if too few patients in either group (Can't do reliable statistics with tiny groups)
  if (n_mutated < 3 || n_non_mutated < 3) {
    next
  }
  
  # Create survival object for DSS
  surv_dss <- Surv(
    time = merged_data$DSS_MONTHS,
    event = 1 - merged_data$DSS_STATUS  # Convert to event (1 = death)
  )
  
  # Fit Kaplan-Meier model (changes 0 -> Non-mutated & 1 -> mutated)
  merged_data$Gene_Status <- factor(
    merged_data$Gene_Mutated,
    levels = c(0, 1),
    labels = c("Non-Mutated", "Mutated")
  )
  
  fit_km <- survfit(surv_dss ~ Gene_Status, data = merged_data)
  
  # Perform log-rank test
  log_rank_test <- survdiff(surv_dss ~ Gene_Status, data = merged_data)
  log_rank_p <- pchisq(log_rank_test$chisq, 
                       length(log_rank_test$n) - 1, 
                       lower.tail = FALSE)
  
  # Fit Cox proportional hazards model
  cox_model <- coxph(surv_dss ~ Gene_Mutated, data = merged_data)
  cox_summary <- summary(cox_model)
  
  # Extract hazard ratio and confidence interval
  hr <- cox_summary$conf.int[1, 1] # Hazard Ratio -> 2.35 =  2.35x higher risk
  ci_lower <- cox_summary$conf.int[1, 3] # 95% confidence upper bound
  ci_upper <- cox_summary$conf.int[1, 4] # 95% confidence lower bound
  cox_p <- cox_summary$coefficients[1, 5] # P-value from Cox model
  
  # Store results
  gene_dss_results <- rbind(gene_dss_results, data.frame(
    Gene = gene,
    Mutated_Patients = n_mutated,
    Non_Mutated_Patients = n_non_mutated,
    Hazard_Ratio = hr,
    CI_Lower = ci_lower,
    CI_Upper = ci_upper,
    P_Value = cox_p,
    Log_Rank_P = log_rank_p,
    stringsAsFactors = FALSE
  ))
  
  # Create and store survival plot for significant genes (p < 0.05)
  if (log_rank_p < 0.05) {
    plot_obj <- ggsurvplot(
      fit_km,
      data = merged_data,
      pval = TRUE,
      conf.int = TRUE,
      risk.table = TRUE,
      palette = c("blue", "red"),
      title = paste0("DSS for ", gene, " Mutation"),
      xlab = "Time (Months)",
      ylab = "Disease-Specific Survival Probability",
      legend.labs = c("Non-Mutated", "Mutated"),
      ggtheme = theme_minimal(base_size = 12)
    )
    survival_plots_list[[gene]] <- plot_obj
  }
}

# Display results sorted by p-value
gene_dss_results <- gene_dss_results[order(gene_dss_results$P_Value), ]
print(gene_dss_results)
```

## 3.26 Multiple Testing Correction
# Adjust p-values for 20 comparisons
```{r inv7_correction}
# Apply Bonferroni correction
gene_dss_results$P_Value_Bonferroni <- p.adjust(
  gene_dss_results$P_Value, 
  method = "bonferroni"
)

# Apply Benjamini-Hochberg FDR correction
gene_dss_results$P_Value_FDR <- p.adjust(
  gene_dss_results$P_Value, 
  method = "fdr"
)

# Summary of results
cat("\nMULTIPLE TESTING CORRECTION RESULTS\n\n")

# Count significant genes at different thresholds
n_nominal <- sum(gene_dss_results$P_Value < 0.05)
n_fdr <- sum(gene_dss_results$P_Value_FDR < 0.05)
n_bonf <- sum(gene_dss_results$P_Value_Bonferroni < 0.05)

cat("Genes significant BEFORE correction (p < 0.05):", n_nominal, "\n")
cat("Genes significant AFTER FDR correction (p < 0.05):", n_fdr, "\n")
cat("Genes significant AFTER Bonferroni correction (p < 0.05):", n_bonf, "\n\n")

# Show top 5 candidate genes
cat("TOP 5 CANDIDATE GENES (Ranked by P-Value) \n\n")
top5 <- head(gene_dss_results[, c("Gene", "Mutated_Patients", "Hazard_Ratio", 
                                   "P_Value", "P_Value_FDR", "P_Value_Bonferroni")], 5)
print(top5, row.names = FALSE)

# If any genes passed FDR correction, show them
if (n_fdr > 0) {
  cat("\n GENES PASSING FDR CORRECTION\n\n")
  significant_genes_fdr <- gene_dss_results[gene_dss_results$P_Value_FDR < 0.05, 
                                             c("Gene", "Hazard_Ratio", "P_Value", "P_Value_FDR")]
  print(significant_genes_fdr, row.names = FALSE)
} else {
  cat("\n*** No genes reached statistical significance after FDR correction ***\n")
  cat("This suggests that while some genes show suggestive associations,\n")
  cat("the evidence is not strong enough to confidently rule out chance findings.\n")
}

# Interpretation note for nominally significant genes
if (n_nominal > 0 & n_fdr == 0) {
  cat("\nINTERPRETATION \n")
  cat("Although", n_nominal, "gene(s) showed p < 0.05 before correction,\n")
  cat("none survived multiple testing correction. This means:\n")
  cat("1. These associations may be worth investigating in larger studies\n")
  cat("2. They should be considered hypothesis-generating, not confirmed\n")
  cat("3. Larger sample sizes may be needed to detect true effects\n")
}

```

## 3.27 Visualize Results
# Create forest plot and summary table
```{r inv7_visualize}
library(ggplot2)

# Create forest plot of hazard ratios with confidence intervals
gene_dss_results$Gene <- factor(
  gene_dss_results$Gene, 
  levels = gene_dss_results$Gene[order(gene_dss_results$Hazard_Ratio)]
)

# Add significance marker
gene_dss_results$Significant <- ifelse(
  gene_dss_results$P_Value_FDR < 0.05, 
  "Significant (FDR < 0.05)", 
  "Not Significant"
)

# Forest plot
forest_plot <- ggplot(gene_dss_results, 
                      aes(x = Hazard_Ratio, y = Gene, color = Significant)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.3) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  scale_color_manual(values = c("Significant (FDR < 0.05)" = "red", 
                                "Not Significant" = "grey60")) +
  labs(
    title = "Forest Plot: Hazard Ratios for Disease-Specific Survival",
    subtitle = "Top 20 Mutated Genes in KIRC",
    x = "Hazard Ratio (95% CI)",
    y = "Gene",
    color = "Significance"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
  )

print(forest_plot)

# Create comprehensive summary table
summary_table <- gene_dss_results[, c("Gene", "Mutated_Patients", 
                                      "Hazard_Ratio", "CI_Lower", "CI_Upper", 
                                      "P_Value", "P_Value_FDR")]
summary_table$HR_95CI <- sprintf("%.2f (%.2f-%.2f)", 
                                 summary_table$Hazard_Ratio,
                                 summary_table$CI_Lower,
                                 summary_table$CI_Upper)

# Round numeric columns
summary_table$P_Value <- format.pval(summary_table$P_Value, digits = 3)
summary_table$P_Value_FDR <- format.pval(summary_table$P_Value_FDR, digits = 3)

# Select final columns
final_table <- summary_table[, c("Gene", "Mutated_Patients", "HR_95CI", 
                                 "P_Value", "P_Value_FDR")]
colnames(final_table) <- c("Gene", "N Mutated", "HR (95% CI)", 
                           "P-Value", "Adjusted P (FDR)")

cat("\n=== Summary Table: Gene Mutations and Disease-Specific Survival ===\n")
print(final_table, row.names = FALSE)

# Display survival plots for significant genes
if (length(survival_plots_list) > 0) {
  cat("\n=== Kaplan-Meier Curves for Significant Genes ===\n")
  for (gene_name in names(survival_plots_list)) {
    print(survival_plots_list[[gene_name]])
  }
}
```

**Observations:**

The analysis reveals several key findings about gene mutations and disease-specific survival in KIRC patients:

1. **Prognostic Genes**: Genes with hazard ratios significantly different from 1.0 (after FDR correction) represent important prognostic biomarkers. 
   - HR > 1: Mutations associated with worse survival (harmful)
   - HR < 1: Mutations associated with better survival (protective)

2. **Effect Size**: The magnitude of the hazard ratio indicates the strength of association. Genes with HR > 2 or < 0.5 have particularly strong effects on survival.

3. **Statistical Significance**: Multiple testing correction (FDR) is crucial when testing 20 genes to control for false positives. Genes significant after correction represent robust associations.

4. **Clinical Implications**: Genes significantly associated with DSS could serve as:
   - Prognostic biomarkers for risk stratification
   - Potential therapeutic targets
   - Indicators for treatment selection


## 3.28 ALTERNATIVE ANALYSIS: Synonymous vs Non-Synonymous Mutations
# Compare survival outcomes by mutation type
```{r inv7_mutation_type}

#I'm not sure if this section makes sense. I don't know if I did the analysis right here. Another set of eyes would be great here. 

synonymous_types <- c("Silent")

non_synonymous_types <- c(
  "Missense_Mutation",
  "Nonsense_Mutation", 
  "Frame_Shift_Del",
  "Frame_Shift_Ins",
  "Splice_Site",
  "In_Frame_Del",
  "In_Frame_Ins",
  "Translation_Start_Site",
  "Nonstop_Mutation"
)

# Initialize results for mutation type analysis
mutation_type_results <- data.frame(
  Gene = character(),
  N_Synonymous = integer(),
  N_NonSynonymous = integer(),
  N_NoMutation = integer(),
  P_Value_Overall = numeric(),
  stringsAsFactors = FALSE
)

# We need to use the full mutations dataset (not just non_synonymous_dataset) because we need to find synonymous mutations too
all_mutations_common <- data_mutations[
  substr(data_mutations$Tumor_Sample_Barcode, 1, 12) %in% common_patients, 
]

# Analyze each top gene
for (gene in top_20_gene_names) {
  
  # Get all mutations for this gene (including synonymous)
  gene_mut_data <- all_mutations_common[
    all_mutations_common$Hugo_Symbol == gene, 
  ]
  
  # Skip if no mutations
  if (nrow(gene_mut_data) == 0) next
  
  # Create mutation type classification for each patient
  mutation_status <- data.frame(
    PATIENT_ID = common_patients,
    Mutation_Type = "None",
    stringsAsFactors = FALSE
  )
  
  for (i in 1:nrow(gene_mut_data)) {
    patient_id <- substr(gene_mut_data$Tumor_Sample_Barcode[i], 1, 12)
    var_class <- gene_mut_data$Variant_Classification[i]
    
    if (patient_id %in% mutation_status$PATIENT_ID) {
      if (var_class %in% synonymous_types) {
        mutation_status$Mutation_Type[mutation_status$PATIENT_ID == patient_id] <- "Synonymous"
      } else if (var_class %in% non_synonymous_types) {
        mutation_status$Mutation_Type[mutation_status$PATIENT_ID == patient_id] <- "Non-Synonymous"
      }
    }
  }
  
  # Merge with clinical data
  merged_data <- merge(
    data_clinical_patient,
    mutation_status,
    by = "PATIENT_ID",
    all.x = FALSE
  )
  
  # Remove missing DSS data
  merged_data <- merged_data[!is.na(merged_data$DSS_MONTHS) & 
                             !is.na(merged_data$DSS_STATUS), ]
  
  # Count each group
  n_syn <- sum(merged_data$Mutation_Type == "Synonymous")
  n_nonsyn <- sum(merged_data$Mutation_Type == "Non-Synonymous")
  n_none <- sum(merged_data$Mutation_Type == "None")
  
  # Skip if insufficient data in mutation groups
  if (n_syn < 3 && n_nonsyn < 3) next
  
  # Create survival object
  surv_dss <- Surv(
    time = merged_data$DSS_MONTHS,
    event = 1 - merged_data$DSS_STATUS
  )
  
  # Determine which groups actually exist
  existing_groups <- unique(merged_data$Mutation_Type)
  
  # Create factor with only existing levels
  merged_data$Mutation_Type <- factor(
    merged_data$Mutation_Type,
    levels = existing_groups
  )
  
  # Fit Kaplan-Meier by mutation type
  fit_type <- survfit(surv_dss ~ Mutation_Type, data = merged_data)
  
  # Log-rank test
  log_rank_test <- survdiff(surv_dss ~ Mutation_Type, data = merged_data)
  p_overall <- pchisq(log_rank_test$chisq, 
                     length(log_rank_test$n) - 1, 
                     lower.tail = FALSE)
  
  # Store results
  mutation_type_results <- rbind(mutation_type_results, data.frame(
    Gene = gene,
    N_Synonymous = n_syn,
    N_NonSynonymous = n_nonsyn,
    N_NoMutation = n_none,
    P_Value_Overall = p_overall,
    stringsAsFactors = FALSE
  ))
  
  # Plot if significant (p < 0.05) and sufficient data
  if (p_overall < 0.05 && (n_syn >= 3 || n_nonsyn >= 3)) {
    
    # Create dynamic legend labels based on which groups exist
    # Match colors to specific mutation types (not order-dependent)
    legend_labels <- character()
    palette_colors <- character()
    
    if ("None" %in% existing_groups) {
      legend_labels <- c(legend_labels, "No Mutation")
      palette_colors <- c(palette_colors, "blue")
    }
    if ("Synonymous" %in% existing_groups) {
      legend_labels <- c(legend_labels, "Synonymous")
      palette_colors <- c(palette_colors, "orange")  
    }
    if ("Non-Synonymous" %in% existing_groups) {
      legend_labels <- c(legend_labels, "Non-Synonymous")
      palette_colors <- c(palette_colors, "red")
    }
    
    plot_obj <- ggsurvplot(
      fit_type,
      data = merged_data,
      pval = TRUE,
      conf.int = FALSE,
      risk.table = TRUE,
      palette = palette_colors,
      title = paste0("DSS by Mutation Type: ", gene),
      xlab = "Time (Months)",
      ylab = "Disease-Specific Survival Probability",
      legend.labs = legend_labels,
      ggtheme = theme_minimal(base_size = 12)
    )
    print(plot_obj)
  }
}

# Display results
mutation_type_results <- mutation_type_results[
  order(mutation_type_results$P_Value_Overall), 
]

cat("\nMUTATION TYPE ANALYSIS RESULTS \n\n")
print(mutation_type_results, row.names = FALSE)

# Summary interpretation
if (nrow(mutation_type_results) == 0) {
  cat("\n*** No genes had sufficient data for mutation type analysis ***\n")
  cat("This occurs when genes have very few or no synonymous mutations.\n")
} else {
  cat("\nINTERPRETATION \n")
  cat("This analysis tests whether the FUNCTIONAL IMPACT of mutations matters.\n")
  cat("- Synonymous mutations: Change DNA but NOT protein (usually harmless)\n")
  cat("- Non-synonymous mutations: Change DNA AND protein (potentially damaging)\n\n")
  
  if (any(mutation_type_results$P_Value_Overall < 0.05)) {
    cat("Genes with p < 0.05 show that mutation type affects survival.\n")
    cat("If non-synonymous mutations have worse outcomes, it suggests the\n")
    cat("functional disruption of the protein drives disease progression.\n")
  } else {
    cat("No genes showed significant differences between mutation types.\n")
    cat("This may indicate:\n")
    cat("1. Sample sizes are too small to detect differences\n")
    cat("2. Very few synonymous mutations exist in these genes\n")
    cat("3. The analysis is underpowered for this comparison\n")
  }
}

```



# ==============================================================================
# SECTION 5: DISCUSSION AND CONCLUSIONS
# ==============================================================================

## 5.1 Key Findings Summary

**Demographics:**
# [WRITE HERE: Summary of patient characteristics]

**Survival Patterns:**
# [WRITE HERE: Key survival trends, median times, prognostic factors]

**Mutation Landscape:**
# [WRITE HERE: Most frequently mutated genes, their biological significance]

**Patient Subgroups:**
# [WRITE HERE: Clusters identified, clinical differences, prognostic value]

**Gene Interactions:**
# [WRITE HERE: Co-mutations and mutual exclusivity patterns]

**Prognostic Biomarkers:**
# [WRITE HERE: Genes associated with survival, potential therapeutic targets]


## 5.2 Biological Interpretation

# [WRITE HERE: Discuss biological meaning of findings]
# - Are the top mutated genes known cancer drivers?
# - Do clusters represent known molecular subtypes?
# - What do co-mutation patterns suggest about tumor evolution?
# - Clinical implications for treatment stratification


## 5.3 Limitations

# [WRITE HERE: Study limitations]
# - Sample size considerations
# - Missing data
# - Potential confounders not adjusted for
# - Limitations of clustering methods used


## 5.4 Future Directions

# [WRITE HERE: Suggested next steps]
# - Validation in independent cohorts
# - Functional studies of candidate genes
# - Integration with other -omics data
# - Clinical trial design based on subgroups


# ==============================================================================
# END OF ANALYSIS
# ==============================================================================

